# 보라해 팬 사이트 – 기능 개선 계획 및 반영 내역

예전 채팅/대화에서 논의한 기능 개선 내용을 정리한 문서입니다.

---

## 1. API 키 및 로컬 환경

- **문제**: Windows CRLF로 인한 `.env` 값에 `\r` 포함 → API 401 오류
- **조치**: `scripts/local-server.js`, `check-openai-key.js`에서 값을 읽을 때 `\r` 제거
- **검증**: `node scripts/check-openai-key.js`로 키 검증 가능

---

## 2. 소아베 영상 카테고리 및 채팅 연동

- **목표**: 69개 소아베 영상을 카테고리별로 분류하고, 채팅 말에 맞춰 해당 영상 재생
- **반영**:
  - `image/soave/ani/soave-video-categories.json`에 69개 경로 + 카테고리(dance, greeting, happy, cry, horong, gorong 등) 고정
  - `tools/soave-video-classifier.html`로 영상 보면서 카테고리 지정 후 JSON 내보내기
  - 채팅 응답의 `[ACTION:play-soave-video:카테고리]` 파싱 → 해당 카테고리 영상 즉시 재생
  - AI 시스템 프롬프트에 "소아베 영상 표정/행동 연동" 규칙 및 예시 추가

---

## 3. 배포 (Cloudflare Pages)

- **목표**: Git 푸시 후 자동 배포
- **반영**:
  - 빌드 명령: `npm run build`
  - Build output directory: `dist`
  - `scripts/build-pages.js` 끝에 `dist/index.html` 존재 검사 추가
  - 문서: `CLOUDFLARE_PAGES.md`에 빌드·출력 디렉터리 안내

---

## 4. 모바일 CTA – 위쪽 화살표 잘림

- **문제**: 배포 사이트(borahae.fan) 모바일 맨 하단에서 OpenAI 로고 오른쪽 "위로 보는 화살표"가 안 보임
- **원인**: `.phone-screen`의 `overflow: hidden`으로 좁은 폰 목업에서 CTA 오른쪽이 잘림
- **조치**:
  - `.ai-suggestion-default`에 `min-width: 0` 추가
  - 768px 이하에서 CTA 패딩·간격·아이콘 크기 조정해 화살표가 잘리지 않도록 반응형 여유 확보

---

## 5. 채팅 속도와 소아베 영상 재생 맞추기

- **문제**: 채팅과 영상 재생이 어긋나고, 다른 요청을 해도 해당 표정이 즉시 안 나옴
- **조치**:
  - `play-soave-video` 액션만 **1.5초 지연 없이 즉시** 실행 (다른 액션은 기존대로 1.5초 유지)
  - 새 응답이 오면 `playCategory(카테고리)`로 현재 영상을 바로 해당 카테고리로 전환

---

## 6. 컨텍스트가 길어질 때 소아베 반응 누락

- **문제**: 처음엔 잘 반응하다가, 대화가 길어지면 "하트 날려줘" 등에도 영상이 안 나옴
- **원인**:  
  - `max_tokens: 500`으로 응답 잘림 → 맨 끝 액션 태그 손실  
  - 액션 파싱이 "응답 맨 끝"만 인식  
  - "일반 대화에서는 사용하지 마세요" 해석으로 표정 액션 생략
- **조치**:
  - **액션 파싱**: 응답 전체에서 `[ACTION:play-soave-video:카테고리]` 검색 (끝이 잘려도 인식)
  - **사용자 메시지 폴백**: `detectSoaveVideoFromUserMessage()` 추가 – "하트", "춤춰줘", "인사" 등만 있어도 해당 카테고리 재생
  - **max_tokens**: 500 → 600
  - **시스템 프롬프트**: "대화가 길어져도 반응 요청에는 항상 play-soave-video", "play-soave-video는 예외로 항상 붙이세요" 명시

---

## 7. 호롱·고롱·우는 표정 반응 강화

- **호롱**
  - "호롱"만 말하면 → **호롱 → 호롱 꽃 → 호롱 천하장사** 3종 연속 재생
  - "호롱 꽃" → `horong_flower`만
  - "호롱 천하장사" → `horong_strong`만
- **고롱**
  - "고롱" 또는 "고롱 발명가" → `gorong_inventor` 재생
- **우는 표정**
  - "우는 표정" 문구 없이 **슬퍼, 눈물, 울고싶어, 울어, 울어줘** 등만 있어도 → `cry` 카테고리 즉시 재생
- **구현**:
  - `play-soave-video` 이벤트에 `detail.categories` 배열 지원 → 연속 재생(시퀀스)
  - 액션 값에 쉼표 구분 목록 허용 (예: `horong,horong_flower,horong_strong`)
  - `detectSoaveVideoFromUserMessage()`에 호롱 꽃/천하장사, 고롱, 울어/눈물/슬퍼 → cry 매핑 추가
  - 시스템 프롬프트에 호롱 3종·고롱·우는표정 규칙 및 예시 추가

---

## 8. BGM 듣기 – 6곡 무한 반복

- **목표**: `music` 폴더 안 MP3 6개를 BGM 듣기 버튼으로 무한 반복 재생
- **반영**:
  - `window.BGM_PLAYLIST`를 6곡으로 설정  
    (보라빛 신호.mp3, LOVE ARMY.mp3, lovearmy1~4.mp3)
  - 기존 로직이 `ended` 시 다음 곡 → 마지막 곡 다음 1번 곡으로 순환하므로 그대로 무한 반복

---

## 9. 수익성 강화를 위한 기능 재배치 제안 (API 비용 고려)

OpenAI API(특히 DALL-E 3, GPT-4o Vision)는 호출당 비용이 발생하므로, "무제한" 제공은 위험할 수 있습니다. 참고용 가이드라인입니다.

### [Plan A] Free (발견의 단계)

- **타겟:** 신규 유입 및 체험 사용자
- **AI 채팅 (소아베):** 기본 텍스트 대화 무제한 (gpt-4o-mini 사용으로 비용 저렴)
- **패션 이미지 생성 (DALL-E 3):** **월 1회** (체험용)
- **보라해 스타일링 (가상 피팅):** 결과물 미리보기만 가능 (저해상도 또는 워터마크)
- **기타:** 커뮤니티 읽기 전용

### [Plan B] Purple (몰입의 단계 – 추천)

- **타겟:** 주기적으로 코디를 즐기고 굿즈를 구매하는 팬층
- **패션 이미지 생성 (DALL-E 3):** **월 20회** (비용이 큰 부분이므로 횟수 제한 필요)
- **보라해 스타일링 (가상 피팅):** **월 10회** 고해상도 생성 및 저장 가능
- **이미지 분석 (Vision):** 사진 업로드 분석 기능 제공
- **굿즈 혜택:** 상시 10% 할인 + 멤버십 전용 한정판 굿즈 구매권
- **전자책:** 월별 유료 콘텐츠 1권 무료 제공

### [Plan C] VIP (소유의 단계 – 하이엔드)

- **타겟:** 열성 팬 및 퍼스널 쇼퍼 기능이 필요한 사용자
- **패션 이미지 생성 (DALL-E 3):** **일일 5회** (사실상 무제한급)
- **보라해 스타일링 (가상 피팅):** **무제한** (최상위 모델 gpt-4o 사용 권한)
- **1:1 전용 AI 비서:** 개인의 과거 코디 히스토리를 기억하는 전용 소아베 (Memory 기능 활용)
- **굿즈 혜택:** 상시 20% 할인 + 무료 배송 쿠폰 + 신제품 우선 예약
- **독점 혜택:** 오프라인 이벤트(생일 카페 등) 우선 입장권, VIP 전용 디지털 굿즈(NFT 등)

### API 키 관리 및 기술적 고려사항

1. **사용량 추적 (Usage Tracking):** 사용자 ID별로 API 호출 횟수를 DB에 기록하고 제한해야 합니다.
2. **모델 차등화:**
   - **Free:** GPT-4o-mini (빠르고 저렴)
   - **Purple/VIP:** GPT-4o (더 정교한 분석 및 고품질 응답)
3. **DALL-E 3 품질 설정:**
   - **Purple:** `standard` 품질
   - **VIP:** `hd` 품질 (고화질) 제공

### 다음 단계 제안 (미반영)

- 멤버십 섹션 텍스트를 위 제안대로 구체적으로 수정
- 이미지 생성 횟수 제한 로직(로컬 저장소 또는 백엔드) 맛보기 구현

---

## 참고

- **카테고리 데이터**: `image/soave/ani/soave-video-categories.json`
- **채팅/영상 연동**: `main.js` (소아베 비디오 IIFE, `executeAction`, 시스템 프롬프트)
- **배포**: Cloudflare Pages, 빌드 `npm run build`, 출력 `dist`
- **수익화/플랜 참고**: `cursor_.md` 2163–2215 라인 (Plan A/B/C, API 고려사항)
