# 개발 설계: 내 스토리 → 컬러·음악·건축·스타일링 → 일관된 런웨이 영상

## 1. 목표 서비스 요약

사용자가 **이름**과 **생일**만 입력하면, 아래가 **자동·순차**로 이어져 **한 번에** 완성되도록 합니다.

1. **이름** → 나만의 스토리(정체성/서사) 생성
2. **생일** → 소울 컬러 + **이름 스토리가 융합된** 탄생 음악(가사·MP3) 생성
3. **나만의 음악** → **동일한** 미래 건축물 이미지 1장 생성 (악보/음악 기반)
4. **보라해 스타일링** → 내 얼굴 + 추천 옷 → 전신 패션 합성 이미지 1장
5. **최종** → **위 건축물을 배경으로**, 위 전신 합성 인물이 런웨이를 걸어가는 **단일 영상** 출력

**핵심 일관성**:  
- “나의 건축물”은 **한 번만** 정해지고,  
- 탄생뮤직·건축물 결과·런웨이 영상 **전부**에서 **같은 건축물**이 사용되어야 함.

---

## 2. 현재 구조와 보강 포인트

| 단계 | 현재 구현 | 보강·연동 포인트 |
|------|-----------|------------------|
| 이름 | 한글 페르소나(이름 분석) | → “이름 스토리” 텍스트 생성·저장 (스토리 API 또는 기존 프롬프트 확장) |
| 생일 | 소울 컬러 + OpenAI 가사 + Suno MP3 | → 가사 프롬프트에 **이름 스토리** 반드시 포함해 “융합 스토리”로 가사·음악 생성 |
| 음악→건축 | 매직샵: 악보/MIDI → 한글 미래 건축물 | → **탄생뮤직(가사/곡 설명)** 을 건축 입력으로 사용하는 경로 추가, 출력 1장을 “나의 건축물”로 고정 |
| 스타일링 | 얼굴 + 추천 옷 → 전신 합성 | → 결과 이미지 URL/Base64를 “나의 전신 패션 이미지”로 저장·다음 단계에 전달 |
| 영상 | Veo: 건축물 이미지 → 영상 | → **런웨이**: “전신 패션 이미지 + 동일 건축물 배경”을 입력으로 하는 영상 생성( Runway/Veo 등) |

---

## 3. 데이터 흐름(자동 연쇄)

```
[사용자 입력]
  이름, 생일
       ↓
[1] 이름 스토리 생성 (텍스트)
  → 저장: userStory
       ↓
[2] 소울 컬러 + 탄생뮤직
  - 소울 컬러: 기존 로직
  - 가사: OpenAI (프롬프트에 userStory + 소울 컬러 반영)
  - MP3: Suno API (가사 → 음원)
  → 저장: soulColor, lyrics, musicUrl
       ↓
[3] 나만의 건축물 1장
  - 입력: musicUrl 또는 가사/곡설명 + soulColor + userStory
  - 기존 한글 건축 파이프라인 재사용 (음악→설명→이미지)
  → 저장: architectureImageBase64 (단일 “나의 건축물”)
       ↓
[4] 보라해 스타일링 (전신 합성)
  - 기존: 얼굴 + 추천 옷 → 전신
  → 저장: fullBodyFashionImageBase64
       ↓
[5] 런웨이 영상
  - 입력: fullBodyFashionImageBase64 + architectureImageBase64
  - “동일 건축물 배경에서 위 인물이 걷는 런웨이” 영상 생성
  → 저장: runwayVideoUrl
       ↓
[최종] 한 화면에 재생·다운로드
  - 배경 = 나의 건축물, 인물 = 나의 전신 패션, 일관된 스토리
```

파일/상태는 **세션 단위 하나의 “내 스토리 결과” 객체**에만 쌓고, 각 단계는 이 객체를 읽고·쓰면 되어 수동 전달이 없어집니다.

---

## 4. 단계별 개발 설계

### Phase 1: 이름 스토리 + 탄생뮤직 융합

**목표**: 이름으로 “내 스토리”를 만들고, 탄생뮤직 가사·음원에 이 스토리가 반영되게 함.

| 작업 | 내용 |
|------|------|
| 1.1 이름 스토리 생성 | 이름 입력 시 (또는 기존 페르소나 결과 활용) “이름에 담긴 스토리/정체성” 1~2문단 텍스트 생성. 기존 OpenAI 채팅 또는 전용 프롬프트 호출. |
| 1.2 스토리 저장 | `userStory` 를 전역/세션 상태 또는 `localStorage` 에 저장. 이후 탄생뮤직·건축에서만 읽기. |
| 1.3 탄생뮤직 가사 프롬프트 수정 | `getLyricsPrompt()` 에 **userStory** 를 반드시 포함. “이름 스토리 + 소울 컬러”가 함께 반영된 가사가 나오도록. |
| 1.4 Suno 연동 유지 | 가사 생성 직후 기존처럼 Suno API 호출 → MP3 URL 저장. “내 탄생뮤직 만들기”에서 바로 음원까지 나오는 현재 플로우 유지. |

**산출물**:  
- `userStory` (텍스트)  
- `lyrics`, `musicUrl` (가사 + MP3, 이름 스토리 반영)

---

### Phase 2: “나만의 음악” → “나만의 건축물” 1장 고정

**목표**: 탄생뮤직(가사/곡 설명)을 건축물 생성 입력으로 쓰고, **항상 동일한 1장**을 “나의 건축물”로 씀.

| 작업 | 내용 |
|------|------|
| 2.1 건축 입력 경로 확장 | 기존: 악보/MIDI 이미지. **추가**: “탄생뮤직” 모드 — 가사 + 소울 컬러 + (선택) 곡 제목/설명을 텍스트로 정리해, 기존 “음악→건축” 파이프라인에 넣을 **영감 텍스트** 생성. |
| 2.2 음악→건축 텍스트 생성 | Gemini/OpenAI로 “가사 + 소울 컬러 + 이름 스토리”를 요약한 건축용 프롬프트(영감 문장) 생성. 기존 `buildArchitectureFinalBuildingPrompt` 등과 결합. |
| 2.3 건축물 1회 생성 및 고정 | 위 입력으로 **한 번만** 최종 건축물 이미지 생성. 결과 Base64를 `architectureImageBase64` 로 저장. 이후 모든 단계는 이 1장만 참조. |
| 2.4 UI 연동 | “내 탄생뮤직” 완료(가사+MP3 생성) 후, 옵션 또는 자동으로 “나만의 건축물 만들기” 실행 → 진행 상태 표시 후 완료 시 “나의 건축물” 표시. |

**산출물**:  
- `architectureImageBase64` (단일 이미지, 일관성의 기준)

---

### Phase 3: 스타일링 결과를 “나의 전신 패션”으로 저장

**목표**: 보라해 스타일링 결과(전신 합성)를 다음 단계에서 그대로 쓰기 위해 명시적으로 저장.

| 작업 | 내용 |
|------|------|
| 3.1 전신 결과 저장 | 스타일링 최종 전신 이미지 생성 시, 해당 이미지 Base64(또는 URL)를 `fullBodyFashionImageBase64` 로 저장. 기존 `stylingData` 또는 전역 “내 스토리 결과” 객체에 포함. |
| 3.2 “내 스토리 결과” 객체 설계 | `myStoryResult = { userStory, soulColor, lyrics, musicUrl, architectureImageBase64, fullBodyFashionImageBase64, runwayVideoUrl }` 형태로 통일. 각 단계는 이 객체만 읽고/쓰기. |

**산출물**:  
- `fullBodyFashionImageBase64`  
- `myStoryResult` 구조 확정

---

### Phase 4: 일관된 런웨이 영상(건축물 + 전신 패션)

**목표**: “나의 건축물” 배경 + “나의 전신 패션” 인물이 걸어가는 런웨이 영상 1개 생성.

**일관성 원칙**:  
- 영상 속 배경 건축물 = `architectureImageBase64` 와 **동일**해야 함.  
- 인물 = `fullBodyFashionImageBase64` 와 **동일**해야 함.

| 작업 | 내용 |
|------|------|
| 4.1 API 선택 | **Runway Gen-3 Alpha** (image-to-video): 전신 인물 + 건축 배경을 한 장의 합성 이미지로 만들어 입력하거나, 인물/배경을 각각 참조 이미지로 전달. 또는 **Veo** 등 기존 비디오 API에서 “이미지 + 프롬프트”로 런웨이 연출 지원 여부 확인. |
| 4.2 입력 이미지 구성 | (A) **한 장**: 전신 패션 인물을 “나의 건축물” 이미지 위에 합성한 1장 → 이 1장을 image-to-video 입력. (B) **두 장**: 인물 참조 + 배경 참조를 각각 넘기고, “same building, model walking” 등 프롬프트로 일관성 유도. (A)가 일관성 보장에 유리. |
| 4.3 런웨이 프롬프트 | 예: “Fashion runway walk, one model walking straight toward camera, confident walk, same futuristic building in background, professional fashion show lighting.” (영문 기준) |
| 4.4 영상 생성 및 저장 | 생성된 영상 URL 또는 Blob을 `runwayVideoUrl` (또는 파일)로 저장. “내 스토리 결과”에 반영. |
| 4.5 에러/폴백 | Runway/Veo 실패 시 “나의 건축물 + 나의 전신 이미지” 정지 화면이라도 보여주고, “영상은 준비 중” 등 메시지로 일관된 UX 유지. |

**산출물**:  
- `runwayVideoUrl` (또는 동등한 영상 파일/URL)

---

### Phase 5: 자동 파이프라인 + UX

**목표**: 사용자는 이름·생일·(필요 시) 스타일링만 입력하고, 나머지는 **자동**으로 이어지게 함.

| 작업 | 내용 |
|------|------|
| 5.1 “내 스토리 여정” 플로우 | 단일 진입점: “이름 입력 → 생일 입력 → (선택) 스타일링 진행” 후, “내 스토리 완성하기” 버튼 또는 자동 실행. |
| 5.2 단계별 자동 연쇄 | 1) 이름 스토리 생성 → 2) 소울 컬러 + 가사(스토리 융합) + Suno MP3 → 3) 음악 기반 건축물 1장 → 4) (이미 있으면) 전신 패션 수집 또는 스타일링 유도 → 5) 런웨이 영상 생성. 각 단계 완료 시 다음 단계 트리거, 상태는 `myStoryResult` 에만 기록. |
| 5.3 진행 표시 | 단계별 “이름 스토리 생성 중” → “탄생뮤직 생성 중” → “나만의 건축물 생성 중” → “런웨이 영상 생성 중” 등 메시지 + 로딩 UI. |
| 5.4 최종 화면 | “나의 건축물” + “나의 탄생뮤직”(MP3 재생) + “나의 런웨이 영상” 재생·다운로드. “모든 것이 같은 건축물·같은 나”가 한눈에 보이도록 구성. |

---

## 5. API·기술 매트릭스

| 단계 | API/기능 | 비고 |
|------|----------|------|
| 이름 스토리 | OpenAI (gpt-4o-mini) 또는 기존 채팅 | 프롬프트에 “이름 기반 스토리 1~2문단” 명시 |
| 가사 | OpenAI | 기존 + userStory 반영 |
| MP3 | **Suno API** (현재 연동됨) | 가사 → 음원, 즉시 재생 가능 |
| 건축물 | Gemini 이미지 생성 + 기존 한글 건축 파이프라인 | 입력만 “탄생뮤직 설명” 경로 추가 |
| 전신 패션 | 기존 보라해 스타일링 (DALL·E 등) | 결과를 `fullBodyFashionImageBase64` 로 저장 |
| 런웨이 영상 | **Runway Gen-3** (image-to-video) 또는 **Veo** 등 | 동일 건축 + 동일 인물 보장이 목표 |

---

## 6. 일관성 보장 체크리스트

- [ ] “나의 건축물”은 **한 번만** 생성되고, 그 결과(`architectureImageBase64`)만 전체 플로우에서 재사용.
- [ ] 탄생뮤직 가사 생성 시 **이름 스토리(userStory)** 가 반드시 포함되어, 스토리와 음악이 융합됨.
- [ ] 런웨이 영상의 **배경**은 반드시 위 건축물 이미지(또는 그와 동일한 합성 결과)에서 가져옴.
- [ ] 런웨이 영상의 **인물**은 보라해 스타일링 전신 합성 결과와 동일한 이미지 기반.
- [ ] 모든 중간 결과는 `myStoryResult`(또는 동일 규격)에만 저장해, 단계 간 수동 복사 없이 자동 반영.

---

## 7. 구현 우선순위 제안

1. **1순위**: Phase 1 (이름 스토리 + 탄생뮤직 융합) + Suno API로 “가사 나오면 바로 음악” 유지.  
2. **2순위**: Phase 2 (탄생뮤직 → 나만의 건축물 1장) — 일관된 건축물의 기준 확보.  
3. **3순위**: Phase 3 (스타일링 결과 저장) + Phase 4 (런웨이 영상, Runway/Veo 연동).  
4. **4순위**: Phase 5 (전체 자동 파이프라인 + 최종 화면 UX).

이 순서로 하면 “이름·생일·스타일링만 넣으면, 같은 건축·같은 나로 런웨이까지 이어지는” 일관된 최종 결과물에 단계적으로 도달할 수 있습니다.
